<!DOCTYPE html>
<html dir="ltr"  xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

    <div th:replace="parts/head :: head"></div>

    <body>
        <div  th:replace="parts/preloader :: preloader"></div>
        <div class="main-wrapper" id="main-wrapper">
            <div  th:replace="parts/topbar :: topbar"></div>
            <div  th:replace="parts/left-sidebar :: left-sidebar"></div>
            <div class="page-wrapper">
                <div  th:replace="parts/breadcrumb :: breadcrumb"></div>
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <a class="btn btn-cyan" th:href="${'/companies/' + symbol}">Company detail</a>
                            <a class="btn btn-primary" th:href="@{'/'}">Strong buy companies</a>
                        </div>
                        <div class="col-md-6">
                            <div id="chart_price"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="chart_bollinger"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="chart_stoch"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="chart_rsi"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="chart_macd"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="chart_mfl"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="chart_sma"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="chart_adx"></div>
                        </div>
                    </div>
                </div>
                <div  th:replace="parts/footer :: footer"></div>
            </div>
        </div>
        <div  th:replace="parts/requiredjs :: requiredjs"></div>
        <script src="/js/indicators.js"></script>
        <script>

            function createButton(selector, id, data, description, name, symbol, chart) {
                var obj = $(selector);
                var html = "<form action='#'><div class='row my-form' id='" + id + "'>";

                if (description[0] !== null) {
                    html += "<div class='col-md-2'>";
                    html += "<label>" + description[0] + "</label>"
                    html += "<input type='number' class='margin_bottom little_input' value='" + data[0] + "'> "
                    html += "</div>";
                }

                if (description[1] !== null) {
                    html += "<div class='col-md-2'>";
                    html += "<label>" + description[1] + "</label>"
                    html += "<input type='number' class='margin_top little_input' value='" + data[1] + "'> "
                    html += "</div>";
                }

                if (description[2] !== null) {
                    html += "<div class='col-md-2'>";
                    html += "<label>" + description[2] + "</label>"
                    html += "<input type='number' class='period little_input' value='" + data[2] + "'> "
                    html += "</div>";
                }

                if (description[3] !== null) {
                    html += "<div class='col-md-2'>";
                    html += "<label>" + description[3] + "</label>"
                    html += "<input type='number' class='period_short little_input' value='" + data[3] + "'> "
                    html += "</div>";
                }
                if (description[4] !== null) {
                    html += "<div class='col-md-2'>";
                    html += "<label>" + description[4] + "</label>"
                    html += "<input type='number' class='period_long little_input' value='" + data[4] + "'> "
                    html += "</div>";
                }
                html += "<div class='col-md-2'>";
                html += "<input type='button' class='btn btn-sm btn-warning my-btn' value='Save'>"
                html += "</div>";

                html += "</div></form>";
                var form = $(html);
                var button = form.find('input[type="button"]')
                obj.parent().prepend(form);
                button.unbind('click');
                button.bind('click', function () {
                    updateIndicator(name, symbol, form, chart)
                });
            }

            function updateIndicator(name, symbol, form, chart) {
                var margin_bottom = parseInt(form.find('.margin_bottom').val());
                var margin_top = parseInt(form.find('.margin_top').val());
                var period = parseInt(form.find('.period').val());
                var period_short = parseInt(form.find('.period_short').val());
                var period_long = parseInt(form.find('.period_long').val());

                margin_bottom = isNaN(margin_bottom) ? 0 : margin_bottom;
                margin_top = isNaN(margin_top) ? 0 : margin_top;
                period = isNaN(period) ? 0 : period;
                period_short = isNaN(period_short) ? 0 : period_short;
                period_long = isNaN(period_long) ? 0 : period_long;
                
                $.ajax({
                    url: "/indicator/updateindicator",
                    type: "PUT",
                    data: {
                        symbol: symbol,
                        abbreviation: name,
                        bottomBorder: margin_bottom,
                        topBorder: margin_top,
                        period: period,
                        periodShort: period_short,
                        periodLong: period_long
                    },
                    success: function (obj) {
                        var series;
                        var annotation = {};
                        switch (name) {
                            case "RSI":
                                series = rsi_series(obj);
                                annotation =  rsi_annotation(obj);
                                break;
                            case "STOCHASTIC_SLOW":
                                annotation = stochastic_annotation(obj);
                                series = stochastic_series(obj);
                                break;
                            case "SMA":
                                series = sma_series(obj);
                                break;
                            case "MACD":
                                series = macd_series(obj);
                                break;
                            case "BOLLINGER":
                                series = bollinger_series(obj);
                                break;
                            case "MONEYFLOW":
                                annotation = moneyflow_annotation(obj);
                                series = moneyflow_series(obj);
                                break;
                            case "ADX":
                                annotation = adx_annotation(obj);
                                series = adx_series(obj);
                                break;
                        }
                        
                        chart.updateSeries(series);
                        setTimeout(function(){
                           chart.updateOptions({annotations: annotation}, false, true, false); 
                        }, 1000)
                    }
                });
            }
            //PRICE
            $.ajax({
                url: "/indicator/price/[[${symbol}]]",
                success: function (obj) {
                    var chart_price = new ApexCharts(document.querySelector("#chart_price"), price_option(obj));
                    chart_price.render();

                }
            });
            //RSI
            $.ajax({
                url: "/indicator/rsi/[[${symbol}]]",
                success: function (obj) {
                    var chart_rsi = new ApexCharts(document.querySelector("#chart_rsi"), rsi_option(obj));
                    chart_rsi.render();
                    createButton("#chart_rsi", "ind_rsi", obj.add, ["low", "up", "period", null, null], "RSI", "[[${symbol}]]", chart_rsi);
                }
            });
            //STOCHASTIC
            $.ajax({
                url: "/indicator/stochastic/[[${symbol}]]",
                success: function (obj) {
                    var chart_stoch = new ApexCharts(document.querySelector("#chart_stoch"), stochastic_option(obj));
                    chart_stoch.render();
                    createButton("#chart_stoch", "ind_stoch", obj.add, ["low", "up", "period", "smoothing K", "smoothing D"], "STOCHASTIC_SLOW", "[[${symbol}]]", chart_stoch);
                }
            });
            //SMA
            $.ajax({
                url: "/indicator/sma/[[${symbol}]]",
                success: function (obj) {
                    var chart_sma = new ApexCharts(document.querySelector("#chart_sma"), sma_option(obj));
                    chart_sma.render();
                    createButton("#chart_sma", "ind_sma", obj.add, [null, null, null, "short term", "long term"], "SMA", "[[${symbol}]]", chart_sma);
                }
            });
            //MACD
            $.ajax({
                url: "/indicator/macd/[[${symbol}]]",
                success: function (obj) {
                    var chart_macd = new ApexCharts(document.querySelector("#chart_macd"), macd_option(obj));
                    chart_macd.render();
                    createButton("#chart_macd", "ind_macd", obj.add, [null, null, null, "short term", "long term"], "MACD", "[[${symbol}]]", chart_macd);
                }
            });
            //BOLLINGER
            $.ajax({
                url: "/indicator/bollinger/[[${symbol}]]",
                success: function (obj) {
                    var chart_bollinger = new ApexCharts(document.querySelector("#chart_bollinger"), bollinger_option(obj));
                    chart_bollinger.render();
                    createButton("#chart_bollinger", "ind_bollinger", obj.add, [null, null, "period", null, null], "BOLLINGER", "[[${symbol}]]", chart_bollinger);
                }
            });
            //CANDLES
            /*$.ajax({
             url: "/indicator/candles/[[${symbol}]]",
             success: function (obj) {
             var options = {
             tooltip: {
             fixed: {
             enabled: true,
             position: 'topLeft',
             offsetX: 70,
             offsetY: 40,
             }
             },
             series: [{
             data: obj.CND,
             type: 'candlestick',
             name: 'Open price'
             }],
             chart: {
             toolbar: {
             show: false
             },
             type: 'line',
             height: 400,
             id: 'cnd',
             group: 'ind',
             },
             title: {
             text: 'CandleStick Chart',
             align: 'left'
             }, stroke: {
             width: [1, 1, 1, 1]
             },
             dataLabels: {
             enabled: false
             },
             grid: {
             row: {
             colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
             opacity: 0.5
             },
             },
             xaxis: {
             type: 'datetime',
             axisBorder: {
             show: true,
             color: '#78909C',
             offsetX: 0,
             offsetY: 0
             },
             labels: {
             show: true
             },
             tooltip: {
             enabled: false
             }
             },
             yaxis: {
             show: true,
             axisBorder: {
             show: true,
             color: '#78909C',
             offsetX: 0,
             offsetY: 0
             },
             labels: {
             formatter: (value) => {
             return value.toFixed(2)
             },
             minWidth: 60,
             maxWidth: 60
             }
             },
             legend: {
             show: false
             }
             };
             
             var chart_candle = new ApexCharts(document.querySelector("#chart_candle"), options);
             chart_candle.render();
             }
             });*/
            //MONEYFLOW
            $.ajax({
                url: "/indicator/moneyflow/[[${symbol}]]",
                success: function (obj) {
                    var chart_moneyflow = new ApexCharts(document.querySelector("#chart_mfl"), moneyflow_option(obj));
                    chart_moneyflow.render();
                    createButton("#chart_mfl", "ind_mfl", obj.add, ["low", "up", "period", null, null], "MONEYFLOW", "[[${symbol}]]", chart_moneyflow);
                }
            });
            //ADX
            $.ajax({
                url: "/indicator/adx/[[${symbol}]]",
                success: function (obj) {
                    var chart_adx = new ApexCharts(document.querySelector("#chart_adx"), adx_option(obj));
                    chart_adx.render();
                    var x = createButton("#chart_adx", "ind_adx", obj.add, ["trend", null, "period", null, "sma"], "ADX", "[[${symbol}]]", chart_adx);
                }
            });
        </script>
    </body>
</html>